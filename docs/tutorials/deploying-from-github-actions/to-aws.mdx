---
title: Deploying to AWS
description: Using the Defang Github Action to deploy your project to AWS from your CI/CD pipeline.
---
import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';


# Deploying to AWS from GitHub Actions

This tutorial will show you how to use the [Defang GitHub Action](https://github.com/DefangLabs/defang-github-action) to deploy your project to AWS from your GitHub Actions workflow.

## Prerequisites

- [A Defang Account](/docs/concepts/authentication)
- [A Github Repo](https://docs.github.com/en/get-started/quickstart/create-a-repo)
- [An AWS Account](https://aws.amazon.com)

## Overview

The Defang GitHub Action uses OpenID Connect (OIDC) to securely authenticate with your AWS account without storing long-lived credentials. This requires:

1. An OIDC identity provider in your AWS account that trusts GitHub Actions
2. An IAM role that GitHub Actions can assume
3. A GitHub Actions workflow configured with the correct permissions

The easiest way to set this up is using the **Defang Portal**, which automates the AWS configuration with a single CloudFormation stack. Alternatively, you can configure AWS manually.

---

## Option 1: Using the Defang Portal (Recommended)

The Defang Portal provides a streamlined setup experience that creates all required AWS resources automatically.

### Step 1 - Configure AWS via the Portal

1. Go to [portal.defang.io](https://portal.defang.io) and log in
2. Navigate to **Clouds** → **AWS**
3. Select your GitHub organization
4. Choose whether to allow **all repos** or **private repos only**
5. Enter your AWS Account ID and select your preferred region
6. Click **Launch CloudFormation** to open AWS CloudFormation with pre-filled parameters
7. In AWS CloudFormation, review the stack and click **Create stack**

This creates:
- An OIDC identity provider for GitHub Actions
- An IAM role named `defang-cd-CIRole` with the necessary trust policy
- Other resources needed for Defang deployments

### Step 2 - Create your GitHub Actions workflow

In your GitHub repository, create a new file at `.github/workflows/deploy.yml`:

```yaml
name: Deploy with Defang

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write  # Required for OIDC authentication

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Deploy
        uses: DefangLabs/defang-github-action@v1.3.0
        with:
          provider: aws
        env:
          AWS_REGION: us-west-2  # Change to your preferred region
          AWS_ROLE_ARN: arn:aws:iam::YOUR_AWS_ACCOUNT_ID:role/defang-cd-CIRole
```

Replace:
- `YOUR_AWS_ACCOUNT_ID` with your 12-digit AWS account ID
- `us-west-2` with your preferred AWS region (must match the region you selected in the Portal)

:::tip
The Defang CLI handles OIDC authentication internally when `AWS_ROLE_ARN` is set. You don't need the `aws-actions/configure-aws-credentials` action.
:::

### Step 3 - Configure secrets (if needed)

If your application requires secrets or configuration values, add them to your workflow:

```yaml
- name: Deploy
  uses: DefangLabs/defang-github-action@v1.3.0
  with:
    provider: aws
    config-env-vars: |
      DATABASE_URL
      API_KEY
  env:
    AWS_REGION: us-west-2
    AWS_ROLE_ARN: arn:aws:iam::YOUR_AWS_ACCOUNT_ID:role/defang-cd-CIRole
    DATABASE_URL: ${{ secrets.DATABASE_URL }}
    API_KEY: ${{ secrets.API_KEY }}
```

---

## Option 2: Manual AWS Configuration

If you prefer to configure AWS manually or need more control over the setup, follow these steps.

### Step 1 - Identify your AWS Account ID

<Tabs>
  <TabItem value="cli" label="AWS CLI" default>
    ```bash
    aws sts get-caller-identity --query Account --output text
    ```
  </TabItem>
  <TabItem value="dashboard" label="AWS Dashboard">
    1. Go to the [AWS Management Console](https://aws.amazon.com/console/)
    2. In the top right corner, click on your account name or number
    3. Your AWS Account ID will be displayed in the dropdown menu
  </TabItem>
</Tabs>

### Step 2 - Create an AWS Identity Provider for GitHub Actions

<Tabs>
  <TabItem value="cli" label="AWS CLI" default>
    ```bash
    aws iam create-open-id-connect-provider \
      --url https://token.actions.githubusercontent.com \
      --client-id-list sts.amazonaws.com
    ```
  </TabItem>
  <TabItem value="dashboard" label="AWS Dashboard">
    1. Go to the [AWS IAM Console](https://console.aws.amazon.com/iam/)
    2. Click on **Identity providers** in the left sidebar
    3. Click **Add provider**
    4. Choose **OpenID Connect** as the provider type
    5. For Provider URL, enter: `https://token.actions.githubusercontent.com`
    6. For Audience, enter: `sts.amazonaws.com`
    7. Click **Add provider**
  </TabItem>
</Tabs>

### Step 3 - Create an IAM role with trust relationship

<Tabs>
  <TabItem value="cli" label="AWS CLI" default>
    1. Create a trust policy file (`trust-policy.json`):

    ```json
    {
      "Version": "2012-10-17",
      "Statement": [
        {
          "Effect": "Allow",
          "Principal": {
            "Federated": "arn:aws:iam::YOUR_AWS_ACCOUNT_ID:oidc-provider/token.actions.githubusercontent.com"
          },
          "Action": "sts:AssumeRoleWithWebIdentity",
          "Condition": {
            "StringLike": {
              "token.actions.githubusercontent.com:sub": "repo:YOUR_GITHUB_ORG/*:*"
            },
            "StringEquals": {
              "token.actions.githubusercontent.com:aud": "sts.amazonaws.com"
            }
          }
        }
      ]
    }
    ```

    Replace:
    - `YOUR_AWS_ACCOUNT_ID` with your AWS account ID
    - `YOUR_GITHUB_ORG` with your GitHub organization or username

    :::info Subject Pattern Examples
    - `repo:MyOrg/*:*` - All repos in MyOrg, all branches
    - `repo:MyOrg/my-repo:*` - Specific repo, all branches
    - `repo:MyOrg/my-repo:ref:refs/heads/main` - Specific repo, main branch only
    :::

    2. Create the role:

    ```bash
    aws iam create-role \
      --role-name defang-cd-CIRole \
      --assume-role-policy-document file://trust-policy.json

    aws iam attach-role-policy \
      --role-name defang-cd-CIRole \
      --policy-arn arn:aws:iam::aws:policy/AdministratorAccess
    ```

  </TabItem>
  <TabItem value="dashboard" label="AWS Dashboard">
    1. Go to the [AWS IAM Console](https://console.aws.amazon.com/iam/)
    2. Click **Roles** → **Create role**
    3. Select **Web identity** as the trusted entity type
    4. Select the GitHub OIDC provider you created
    5. For Audience, select `sts.amazonaws.com`
    6. Click **Next**
    7. Search for and select `AdministratorAccess`
    8. Click **Next**
    9. Enter role name: `defang-cd-CIRole`
    10. Click **Create role**
    11. After creation, click on the role and go to **Trust relationships** → **Edit trust policy**
    12. Update the `Condition` block to restrict access to your GitHub organization:

    ```json
    "Condition": {
      "StringLike": {
        "token.actions.githubusercontent.com:sub": "repo:YOUR_GITHUB_ORG/*:*"
      },
      "StringEquals": {
        "token.actions.githubusercontent.com:aud": "sts.amazonaws.com"
      }
    }
    ```
  </TabItem>
</Tabs>

### Step 4 - Create your GitHub Actions workflow

Use the same workflow as shown in [Option 1, Step 2](#step-2---create-your-github-actions-workflow).

---

## Important Notes

### Stack Configuration Files

If you have a `.defang/` directory with stack configuration files (e.g., `.defang/production`), make sure they don't include `AWS_PROFILE`. The profile setting is for local development only and will cause errors in CI/CD:

```bash
# .defang/production - CI/CD compatible
AWS_REGION="us-west-2"
DEFANG_PROVIDER="aws"
```

```bash
# .defang/production - NOT CI/CD compatible (will fail)
AWS_PROFILE="my-local-profile"  # Remove this line
AWS_REGION="us-west-2"
DEFANG_PROVIDER="aws"
```

### Permissions

The workflow requires these GitHub Actions permissions:
- `contents: read` - To checkout your code
- `id-token: write` - To request an OIDC token for AWS authentication

### Troubleshooting

**Error: "failed to get shared config profile"**
- Remove `AWS_PROFILE` from your `.defang/` stack configuration files

**Error: "AccessDenied" when assuming role**
- Verify the role's trust policy includes your GitHub organization/repo
- Check that `id-token: write` permission is set in the workflow
- Ensure the role ARN in your workflow matches the actual role name

**Error: "OIDC provider not found"**
- Ensure the OIDC provider was created in the correct AWS account
- Verify the provider URL is exactly `https://token.actions.githubusercontent.com`

---

## Additional Resources

- [Defang GitHub Action Repository](https://github.com/DefangLabs/defang-github-action)
- [GitHub Actions OIDC Documentation](https://docs.github.com/en/actions/deployment/security-hardening-your-deployments/about-security-hardening-with-openid-connect)
- [AWS IAM OIDC Documentation](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_providers_create_oidc.html)
